import XCTest
@testable import MediaDetailDemo

class APIRepositoryTests: XCTestCase {

    override func setUpWithError() throws {
        // Put setup code here. This method is called before the invocation of each test method in the class.
    }

    override func tearDownWithError() throws {
        // Put teardown code here. This method is called after the invocation of each test method in the class.
    }

    func testExample() throws {
        // This is an example of a functional test case.
        // Use XCTAssert and related functions to verify your tests produce the correct results.
    }

    func testPerformanceExample() throws {
        // This is an example of a performance test case.
        self.measure {
            // Put the code you want to measure the time of here.
        }
    }

    func testGetMoviesSuccessReturnsMovies()  {
        let jsonData = "{\n  \"page\": 1,\n  \"results\": [\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/yizL4cEKsVvl17Wc1mGEIrQtM2F.jpg\",\n      \"genre_ids\": [\n        28,\n        878,\n        12\n      ],\n      \"id\": 588228,\n      \"original_language\": \"en\",\n      \"original_title\": \"The Tomorrow War\",\n      \"overview\": \"The world is stunned when a group of time travelers arrive from the year 2051 to deliver an urgent message: Thirty years in the future, mankind is losing a global war against a deadly alien species. The only hope for survival is for soldiers and civilians from the present to be transported to the future and join the fight. Among those recruited is high school teacher and family man Dan Forester. Determined to save the world for his young daughter, Dan teams up with a brilliant scientist and his estranged father in a desperate quest to rewrite the fate of the planet.\",\n      \"popularity\": 4048.477,\n      \"poster_path\": \"/34nDCQZwaEvsy4CFO5hkGRFDCVU.jpg\",\n      \"release_date\": \"2021-09-03\",\n      \"title\": \"The Tomorrow War\",\n      \"video\": false,\n      \"vote_average\": 8,\n      \"vote_count\": 181\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/jlGmlFOcfo8n5tURmhC7YVd4Iyy.jpg\",\n      \"genre_ids\": [\n        28,\n        12,\n        14,\n        35\n      ],\n      \"id\": 436969,\n      \"original_language\": \"en\",\n      \"original_title\": \"The Suicide Squad\",\n      \"overview\": \"Supervillains Harley Quinn, Bloodsport, Peacemaker and a collection of nutty cons at Belle Reve prison join the super-secret, super-shady Task Force X as they are dropped off at the remote, enemy-infused island of Corto Maltese.\",\n      \"popularity\": 3184.405,\n      \"poster_path\": \"/iXbWpCkIauBMStSTUT9v4GXvdgH.jpg\",\n      \"release_date\": \"2021-07-28\",\n      \"title\": \"The Suicide Squad\",\n      \"video\": false,\n      \"vote_average\": 8,\n      \"vote_count\": 3420\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/nDLylQOoIazGyYuWhk21Yww5FCb.jpg\",\n      \"genre_ids\": [\n        28,\n        12,\n        14\n      ],\n      \"id\": 566525,\n      \"original_language\": \"en\",\n      \"original_title\": \"Shang-Chi and the Legend of the Ten Rings\",\n      \"overview\": \"Shang-Chi must confront the past he thought he left behind when he is drawn into the web of the mysterious Ten Rings organization.\",\n      \"popularity\": 2541.165,\n      \"poster_path\": \"/1BIoJGKbXjdFDAqUEiA2VHqkK1Z.jpg\",\n      \"release_date\": \"2021-09-01\",\n      \"title\": \"Shang-Chi and the Legend of the Ten Rings\",\n      \"video\": false,\n      \"vote_average\": 8,\n      \"vote_count\": 250\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/7WJjFviFBffEJvkAms4uWwbcVUk.jpg\",\n      \"genre_ids\": [\n        12,\n        14,\n        35,\n        28\n      ],\n      \"id\": 451048,\n      \"original_language\": \"en\",\n      \"original_title\": \"Jungle Cruise\",\n      \"overview\": \"Dr. Lily Houghton enlists the aid of wisecracking skipper Frank Wolff to take her down the Amazon in his dilapidated boat. Together, they search for an ancient tree that holds the power to heal – a discovery that will change the future of medicine.\",\n      \"popularity\": 2503.522,\n      \"poster_path\": \"/9dKCd55IuTT5QRs989m9Qlb7d2B.jpg\",\n      \"release_date\": \"2021-07-28\",\n      \"title\": \"Jungle Cruise\",\n      \"video\": false,\n      \"vote_average\": 7.9,\n      \"vote_count\": 2345\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/nprqOIEfiMMQx16lgKeLf3rmPrR.jpg\",\n      \"genre_ids\": [\n        28,\n        53,\n        18\n      ],\n      \"id\": 619297,\n      \"original_language\": \"en\",\n      \"original_title\": \"Sweet Girl\",\n      \"overview\": \"A devastated husband vows to bring justice to the people responsible for his wife's death while protecting the only family he has left, his daughter.\",\n      \"popularity\": 2203.806,\n      \"poster_path\": \"/cP7odDzzFBD9ycxj2laTeFWGLjD.jpg\",\n      \"release_date\": \"2021-08-18\",\n      \"title\": \"Sweet Girl\",\n      \"video\": false,\n      \"vote_average\": 6.9,\n      \"vote_count\": 428\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/mtRW6eAwOO27h3zrfU2foQFW7Hg.jpg\",\n      \"genre_ids\": [\n        16,\n        10751,\n        12,\n        35\n      ],\n      \"id\": 675445,\n      \"original_language\": \"en\",\n      \"original_title\": \"PAW Patrol: The Movie\",\n      \"overview\": \"Ryder and the pups are called to Adventure City to stop Mayor Humdinger from turning the bustling metropolis into a state of chaos.\",\n      \"popularity\": 2248.545,\n      \"poster_path\": \"/ic0intvXZSfBlYPIvWXpU1ivUCO.jpg\",\n      \"release_date\": \"2021-08-09\",\n      \"title\": \"PAW Patrol: The Movie\",\n      \"video\": false,\n      \"vote_average\": 8,\n      \"vote_count\": 334\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/dq18nCTTLpy9PmtzZI6Y2yAgdw5.jpg\",\n      \"genre_ids\": [\n        28,\n        12,\n        53,\n        878\n      ],\n      \"id\": 497698,\n      \"original_language\": \"en\",\n      \"original_title\": \"Black Widow\",\n      \"overview\": \"Natasha Romanoff, also known as Black Widow, confronts the darker parts of her ledger when a dangerous conspiracy with ties to her past arises. Pursued by a force that will stop at nothing to bring her down, Natasha must deal with her history as a spy and the broken relationships left in her wake long before she became an Avenger.\",\n      \"popularity\": 1989.164,\n      \"poster_path\": \"/qAZ0pzat24kLdO3o8ejmbLxyOac.jpg\",\n      \"release_date\": \"2021-07-07\",\n      \"title\": \"Black Widow\",\n      \"video\": false,\n      \"vote_average\": 7.8,\n      \"vote_count\": 4728\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/pUc51UUQb1lMLVVkDCaZVsCo37U.jpg\",\n      \"genre_ids\": [\n        53,\n        27\n      ],\n      \"id\": 482373,\n      \"original_language\": \"en\",\n      \"original_title\": \"Don't Breathe 2\",\n      \"overview\": \"The Blind Man has been hiding out for several years in an isolated cabin and has taken in and raised a young girl orphaned from a devastating house fire. Their quiet life together is shattered when a group of criminals kidnap the girl, forcing the Blind Man to leave his safe haven to save her.\",\n      \"popularity\": 1695.663,\n      \"poster_path\": \"/hRMfgGFRAZIlvwVWy8DYJdLTpvN.jpg\",\n      \"release_date\": \"2021-08-12\",\n      \"title\": \"Don't Breathe 2\",\n      \"video\": false,\n      \"vote_average\": 7.5,\n      \"vote_count\": 205\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/8s4h9friP6Ci3adRGahHARVd76E.jpg\",\n      \"genre_ids\": [\n        16,\n        35,\n        10751,\n        878\n      ],\n      \"id\": 379686,\n      \"original_language\": \"en\",\n      \"original_title\": \"Space Jam: A New Legacy\",\n      \"overview\": \"When LeBron and his young son Dom are trapped in a digital space by a rogue A.I., LeBron must get them home safe by leading Bugs, Lola Bunny and the whole gang of notoriously undisciplined Looney Tunes to victory over the A.I.'s digitized champions on the court. It's Tunes versus Goons in the highest-stakes challenge of his life.\",\n      \"popularity\": 1789.917,\n      \"poster_path\": \"/5bFK5d3mVTAvBCXi5NPWH0tYjKl.jpg\",\n      \"release_date\": \"2021-07-08\",\n      \"title\": \"Space Jam: A New Legacy\",\n      \"video\": false,\n      \"vote_average\": 7.4,\n      \"vote_count\": 2060\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/1Txzm4bY5ZDqvgMl7MmHeBMl7HH.jpg\",\n      \"genre_ids\": [\n        80,\n        18,\n        53\n      ],\n      \"id\": 860425,\n      \"original_language\": \"es\",\n      \"original_title\": \"Sinaliento\",\n      \"overview\": \"\",\n      \"popularity\": 1676.944,\n      \"poster_path\": \"/oxNoVgbu2v9ETL93Kri1pw8osYf.jpg\",\n      \"release_date\": \"2021-08-11\",\n      \"title\": \"Breathless\",\n      \"video\": false,\n      \"vote_average\": 6.9,\n      \"vote_count\": 17\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/5VydHjmbPiXAfJ2RJWFCjNdLS85.jpg\",\n      \"genre_ids\": [\n        53\n      ],\n      \"id\": 847981,\n      \"original_language\": \"de\",\n      \"original_title\": \"Schwarze Insel\",\n      \"overview\": \"The dark secrets of a seemingly peaceful island threaten to swallow up an orphaned student when he grows close to a mysterious new teacher.\",\n      \"popularity\": 1000.489,\n      \"poster_path\": \"/53jsv5TASLwOqsJNsUNp4RPPq2l.jpg\",\n      \"release_date\": \"2021-08-18\",\n      \"title\": \"Black Island\",\n      \"video\": false,\n      \"vote_average\": 6.4,\n      \"vote_count\": 85\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/AjQgFtfXTmmMVuaH2VfQDdGbeQH.jpg\",\n      \"genre_ids\": [\n        28,\n        18,\n        80\n      ],\n      \"id\": 706972,\n      \"original_language\": \"en\",\n      \"original_title\": \"Narco Sub\",\n      \"overview\": \"A man will become a criminal to save his family.  Director: Shawn Welling  Writer: Derek H. Potts  Stars: Tom Vera, Tom Sizemore, Lee Majors |\",\n      \"popularity\": 1590.289,\n      \"poster_path\": \"/7p0O4mKYLIhU2E5Zcq9Z3vOZ4e9.jpg\",\n      \"release_date\": \"2021-07-22\",\n      \"title\": \"Narco Sub\",\n      \"video\": false,\n      \"vote_average\": 7.1,\n      \"vote_count\": 42\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/j28p5VwI5ieZnNwfeuZ5Ve3mPsn.jpg\",\n      \"genre_ids\": [\n        35,\n        28,\n        12,\n        878\n      ],\n      \"id\": 550988,\n      \"original_language\": \"en\",\n      \"original_title\": \"Free Guy\",\n      \"overview\": \"A bank teller called Guy realizes he is a background character in an open world video game called Free City that will soon go offline.\",\n      \"popularity\": 1715.589,\n      \"poster_path\": \"/acCS12FVUQ7blkC8qEbuXbsWEs2.jpg\",\n      \"release_date\": \"2021-08-11\",\n      \"title\": \"Free Guy\",\n      \"video\": false,\n      \"vote_average\": 7.8,\n      \"vote_count\": 544\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/uHmvk8FnoxpgujDU0RIXLkv2fNt.jpg\",\n      \"genre_ids\": [\n        16,\n        35\n      ],\n      \"id\": 573164,\n      \"original_language\": \"es\",\n      \"original_title\": \"Un rescate de huevitos\",\n      \"overview\": \"A rooster and his fowl partner embark on a dangerous trip to the Congo to recover their stolen eggs from a group of Russian goons.\",\n      \"popularity\": 1504.693,\n      \"poster_path\": \"/wrlQnKHLCBheXMNWotyr5cVDqNM.jpg\",\n      \"release_date\": \"2021-08-12\",\n      \"title\": \"Eggs Run\",\n      \"video\": false,\n      \"vote_average\": 8.3,\n      \"vote_count\": 199\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/wjQXZTlFM3PVEUmKf1sUajjygqT.jpg\",\n      \"genre_ids\": [\n        878,\n        28,\n        53\n      ],\n      \"id\": 581726,\n      \"original_language\": \"en\",\n      \"original_title\": \"Infinite\",\n      \"overview\": \"Evan McCauley has skills he never learned and memories of places he has never visited. Self-medicated and on the brink of a mental breakdown, a secret group that call themselves “Infinites” come to his rescue, revealing that his memories are real.\",\n      \"popularity\": 1266.906,\n      \"poster_path\": \"/niw2AKHz6XmwiRMLWaoyAOAti0G.jpg\",\n      \"release_date\": \"2021-06-10\",\n      \"title\": \"Infinite\",\n      \"video\": false,\n      \"vote_average\": 7.5,\n      \"vote_count\": 937\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/nksMy0Uc7Bdg9dAuAV2F2hWKglU.jpg\",\n      \"genre_ids\": [\n        10749,\n        18\n      ],\n      \"id\": 744275,\n      \"original_language\": \"en\",\n      \"original_title\": \"After We Fell\",\n      \"overview\": \"Just as Tessa's life begins to become unglued, nothing is what she thought it would be. Not her friends nor her family. The only person that she should be able to rely on is Hardin, who is furious when he discovers the massive secret that she's been keeping. Before Tessa makes the biggest decision of her life, everything changes because of revelations about her family.\",\n      \"popularity\": 1739.515,\n      \"poster_path\": \"/oOZITZodAja6optBgLh8ZZrgzbb.jpg\",\n      \"release_date\": \"2021-09-01\",\n      \"title\": \"After We Fell\",\n      \"video\": false,\n      \"vote_average\": 8.9,\n      \"vote_count\": 144\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/uZDE9VnKFnIPmWriMjnp82bH9S8.jpg\",\n      \"genre_ids\": [\n        28,\n        53\n      ],\n      \"id\": 825997,\n      \"original_language\": \"en\",\n      \"original_title\": \"Rogue Hostage\",\n      \"overview\": \"A former Marine races against time to save a group of hostages -- including his young daughter and a congressman — when armed militants take over his stepfather's store.\",\n      \"popularity\": 1512.883,\n      \"poster_path\": \"/1ho7YYp1DvCke9I1D3Olbh2Px63.jpg\",\n      \"release_date\": \"2021-06-11\",\n      \"title\": \"Rogue Hostage\",\n      \"video\": false,\n      \"vote_average\": 6.7,\n      \"vote_count\": 70\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/xXHZeb1yhJvnSHPzZDqee0zfMb6.jpg\",\n      \"genre_ids\": [\n        28,\n        80,\n        53\n      ],\n      \"id\": 385128,\n      \"original_language\": \"en\",\n      \"original_title\": \"F9\",\n      \"overview\": \"Dominic Toretto and his crew battle the most skilled assassin and high-performance driver they've ever encountered: his forsaken brother.\",\n      \"popularity\": 1387.804,\n      \"poster_path\": \"/bOFaAXmWWXC3Rbv4u4uM9ZSzRXP.jpg\",\n      \"release_date\": \"2021-05-19\",\n      \"title\": \"F9\",\n      \"video\": false,\n      \"vote_average\": 7.6,\n      \"vote_count\": 3359\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/gX5UrH1TLVVBwI7WxplW43BD6Z1.jpg\",\n      \"genre_ids\": [\n        16,\n        35,\n        12,\n        10751\n      ],\n      \"id\": 459151,\n      \"original_language\": \"en\",\n      \"original_title\": \"The Boss Baby: Family Business\",\n      \"overview\": \"The Templeton brothers — Tim and his Boss Baby little bro Ted — have become adults and drifted away from each other. But a new boss baby with a cutting-edge approach and a can-do attitude is about to bring them together again … and inspire a new family business.\",\n      \"popularity\": 1354.824,\n      \"poster_path\": \"/kv2Qk9MKFFQo4WQPaYta599HkJP.jpg\",\n      \"release_date\": \"2021-07-01\",\n      \"title\": \"The Boss Baby: Family Business\",\n      \"video\": false,\n      \"vote_average\": 7.8,\n      \"vote_count\": 1319\n    },\n    {\n      \"adult\": false,\n      \"backdrop_path\": \"/620hnMVLu6RSZW6a5rwO8gqpt0t.jpg\",\n      \"genre_ids\": [\n        16,\n        35,\n        10751,\n        14\n      ],\n      \"id\": 508943,\n      \"original_language\": \"en\",\n      \"original_title\": \"Luca\",\n      \"overview\": \"Luca and his best friend Alberto experience an unforgettable summer on the Italian Riviera. But all the fun is threatened by a deeply-held secret: they are sea monsters from another world just below the water’s surface.\",\n      \"popularity\": 1290.82,\n      \"poster_path\": \"/jTswp6KyDYKtvC52GbHagrZbGvD.jpg\",\n      \"release_date\": \"2021-06-17\",\n      \"title\": \"Luca\",\n      \"video\": false,\n      \"vote_average\": 8.1,\n      \"vote_count\": 4285\n    }\n  ],\n  \"total_pages\": 500,\n  \"total_results\": 10000\n}".data(using: .utf8)
        let apiRespository = APIRepository()
        let mockURLSession  = MockURLSession(data: jsonData, urlResponse: nil, error: nil)
        apiRespository.session = mockURLSession
        let moviesExpectation = expectation(description: "movies")
        var moviesResponse: MovieDecodable?
        
        apiRespository.getMovieList { (movies, error) in
          moviesResponse = movies
          moviesExpectation.fulfill()
        }
        waitForExpectations(timeout: 1) { (error) in
          XCTAssertNotNil(moviesResponse)
        }
      }
    
    func testGetMoviesWhenResponseErrorReturnsError() {
      let apiRespository = APIRepository()
      let error = NSError(domain: "error", code: 1234, userInfo: nil)
      let mockURLSession  = MockURLSession(data: nil, urlResponse: nil, error: error)
      apiRespository.session = mockURLSession
      let errorExpectation = expectation(description: "error")
      var errorResponse: Error?
      apiRespository.getMovieList { (movies, error) in
        errorResponse = error
        errorExpectation.fulfill()
      }
      waitForExpectations(timeout: 1) { (error) in
        XCTAssertNotNil(errorResponse)
      }
    }

}
